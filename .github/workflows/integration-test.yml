name: Integration Tests

on:
  workflow_call:
  workflow_dispatch:

jobs:
  integration-discover:
    name: Discover Integration Tests
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.collect.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-dev.txt

      - name: Download latest images metadata
        run: |
          curl -fsSL \
            --retry 8 \
            --retry-all-errors \
            --retry-delay 2 \
            --max-time 600 \
            -o config/images-metadata.yaml \
            https://github.com/aicage/aicage-image/releases/latest/download/images-metadata.yaml

      - id: collect
        name: Collect integration tests
        run: |
          python - <<'PY'
          import json
          import os
          import subprocess
          tests = subprocess.check_output(
              ["pytest", "--collect-only", "-q", "-m", "integration"],
              text=True,
          ).splitlines()
          node_ids = [line for line in tests if "::" in line]
          matrix = {"include": [{"test": test} for test in node_ids]}
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write(f"matrix={json.dumps(matrix)}\n")
          PY

  integration:
    name: Integration (${{ matrix.test }})
    runs-on: ubuntu-latest
    needs: integration-discover
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.integration-discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-dev.txt

      - name: Download latest images metadata
        run: |
          curl -fsSL \
            --retry 8 \
            --retry-all-errors \
            --retry-delay 2 \
            --max-time 600 \
            -o config/images-metadata.yaml \
            https://github.com/aicage/aicage-image/releases/latest/download/images-metadata.yaml

      - name: Run integration test
        env:
          AICAGE_RUN_INTEGRATION: "1"
        run: pytest -m integration ${{ matrix.test }}
